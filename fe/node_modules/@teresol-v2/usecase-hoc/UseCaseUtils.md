# Use Case Utils

The **Utils** collection provides following functions and a class to define and implement **Use Case Higher Order Components** (UCHOCs):

- [**`FsmAjax`** class](#fsmajax-class)
- [**`useUseCaseViewManager`** Composable (function)](#useusecaseviewmanager-composable-function)
- [**`defineUseCaseComponent`** function](#defineusecasecomponent-function)
- [**`defineUseCaseLoader`** function](#defineusecaseloader-function)

### Usage

```js
import {
  FsmAjax,
  useUseCaseViewManager,
  defineUseCaseComponent,
  defineUseCaseLoader,
} from "@teresol-v2/usecase-hoc/utils";
```

## `FsmAjax` Class

The `axios` wrapper class for posting **FSM transition** requests

### Constructor

```js
constructor(config: { fsmUrl: String, batchRequired: Boolean, activityCode?: String | undefined, subActivityCode?: String | undefined }): FsmAjax
```

### Instance Properties

- **`url`**: Gets FSM Url
- **`batchRequired`**: Gets whether Batch Required
- **`activityCode`**: Gets Activity Code
- **`subActivityCode`**: Gets Sub-Activity Code

### Static Property

- **`FsmAjax.header`**: Gets header (from **Main Store**)

### Instance Methods

- **`post`**: Posts **FSM transition**
  ```js
  post(transition: String, data?: Object | undefined): Promise<Object>
  ```
- **`postInit`**: Posts FSM **`INIT`** transition
  ```js
  postInit(): Promise<Object>
  ```
- **`postKill`**: Posts FSM **`KILL`** transition
  ```js
  postKill(): Promise<Object>
  ```

### Static Methods

- **`FsmAjax.isFsmError`**: Determines whether specified error is an instance of **FSM Response Error** or not
  ```js
  FsmAjax.isFsmError(error: Error): Boolean
  ```
- **`FsmAjax.pluckErrorData`**: Extracts data from **FSM Response Error**
  ```js
  FsmAjax.pluckErrorData(error: FsmResponseError): Object | undefined
  ```

### _Optionally_ Extend `FsmAjax` for other FSM Transitions

```js
// FSM Transitions
FsmAjax.prototype.postOkBtn = function (data) {
  return this.post("OK_BTN", data);
};
FsmAjax.prototype.postBackBtn = function () {
  return this.post("BACK_BTN");
};
```

## `useUseCaseViewManager` Composable (Function)

A **Vue.js Composable** (function) that manages following operations/behaviors of **Use Case Higher Order Components (UCHOC)**:

- Initializes Use Case by posting **FSM `INIT`** transition, on before mount (`onBeforeMount`), and subsequently based on success/failure either executes specified **`onInitialized`** or **`onError`** callback function respectively.
- Provides **`activateView`** function to navigate from one Use Case _view_ (MegaSet) to another.
- Provides **`activeView`** object that exposes **`name`** and **`$ref`** properties of current **UCHOC view**. The **`name`** property reflects the specified name of the view, whereas **`$ref`** property refers to **Template Ref** of corresponding **MegaSet**.
- Provides **`$refs`** object that exposes **Template Refs** of **UCHOC's MegaSets**, specified in views collection. The **Template Ref** of specific **MegaSet** is accessible through **`$refs.value.ref`\***`ViewName`\*. It should be noted that **Template Ref** of **inactive** views will always be `null` or `undefined`.
- Provides **`reinitialize`** function to reset FSM by posting FSM **`KILL`** and **`INIT`** transitions one after another, eventually either executes specified **`onInitialized`** callback on success or **`onError`** callback on failure.
- Provides **`close`** function to terminate Use Case, and based on its activation scenario either route-back to previous route or emits **`closing`** event back to parent-component. The optional **`kill`** argument of this function controls auto posting of FSM **`KILL`** transition on before unmount (`onBeforeUnmount`).
- Provides **Vue.js** specific **`render`** function, used by **Vue.js** _runtime API_ to create/update **UCHOC** virtual **DOM**.

```js
function useUseCaseViewManager(
  config: Object,
  views: Array<Object>,
  onInitialized: Function,
  onError: Function,
  initView?: String = ''
): Object
```

### Parameters

- **`config`**: Use Case configuration object
  ```javascript
  config: {
    fsmUrl: String,
    batchRequired: Boolean,
    activityCode?: String | undefined,
    subActivityCode?: String | undefined,
    tolerateInit?: Boolean | undefined
  }
  ```
  - **`fsmUrl`**: The URL of **FSM**.
  - **`batchRequired`**: The boolean flag to indicate whether **Batch Number** is required for this Use Case.
  - **`activityCode`** _(Optional)_: The **Activity Code** of Use Case
  - **`subActivityCode`** _(Optional)_: The **Sub Activity Code** of Use Case
  - **`tolerateInit`** _(Optional, defaults to `false`)_: The boolean flag to indicate whether to **tolerate FSM errors** in response of **`INIT`** transition. If set to **`true`** then in case of failure the **`onError`** callback is excuted and subsequent **`close`** call is omitted.
  ***
- **`views`**: An array of objects that define Use Case **views** relative to Use Case **MegaSets**. Through _view definition_ we can also specify multiple _child_ __components__ for a certain _view_.
  ```javascript
  [
    // Single Component View
    { 
      name: String, 
      title: String, 
      component: Object, 
      props: Object, 
      handlers?: Object | undefined 
    },
    // Multiple Child Components
    { 
      name: String, 
      title: String, 
      components: [
        { ref: String, props: Object, handlers?: Object | undefined },
        ...
      ]
    },
    ...
  ]
  ```
  - **`name`**: The _view_ name to be used as argument of **`activateView`** function to refer specific _MegaSet_.
  - **`title`**: The title of the _view_.
  - **`component`**: The imported **MegaSet** (vnode) of the _view_.
  - **`props`**: The configuration object of **MegaSet** (vnode).
  - **`handlers`** _(Optional)_: The event handlers object, corresponding to **MegaSet** emits.
  ***
- **`onInitialized(data)`** _(callback)_: The parameter to specify **callback method** that will be executed on successful initialization of the Use Case.
- **`onError(error)`** _(callback)_: The parameter to specify **callback method** that will be executed on failure of transitions posted by **this composable**. Such as **`INIT`** and/or **`KILL`**.
- **`initView`** _(Optional)_: An optional parameter to specify **name** of the _view_ that should be _activated_ before initialization of **UCHOC**, instead of blank/loading _view_.
### Returns

The **composable** function returns following items:

- **`activateView`**: A function that activates the specified _`view`_.
  ```javascript
  function activateView(view: String): void
  ```
- **`activeView`**: A _computed getter_ that returns an _object_, exposing **name** and **Template Ref** of currently _active view_ through **`name`** and **`$ref`** properties, respectively. Returns `undefined` if currently no _view_ is active.
  ```javascript
  activeView: ComputedRef<{ name: String, $ref: VNode } | undefined>
  ```
- **`$refs`**: A _computed getter_ that returns an _object_, exposing **Template Refs** of UCHOC's **MegaSets**, through properties named after **view's name** prefixed with **`'ref'`**. For Example **`$refs.value.refMegaSet1`** refers to **Template Ref** of _view_ named **`'MegaSet1'`**.
  ```javascript
  $refs: ComputedRef<{ refViewName1: VNode | undefined | null, ..., refViewNameN: VNode | undefined | null }>
  ```
- **`close`**: A function that closes the **UCHOC**, and based on activation scenario either **route-back** to previous route or emits **`closing`** event. The posting of **`KILL`** transition on un-mount can be controlled by **`kill`** parameter.
  ```javascript
  function close(kill: Boolean = true): void
  ```
- **`reinitialize`**: A function that **resets FSM** by posting **`KILL`** and **`INIT`** transitions one after another.
  ```javascript
  function reinitialize(): void
  ```
- **`render`**: A **Vue.js** specific **render function**, to be returned by **UCHOC** implementation (**`setup`** function), and to be called by **Vue.js** runtime API, to create/update **UCHOC** virtual **DOM**.
  ```javascript
  function render(_ctx, _cache): VNode
  ```

### Example

```javascript
// UseCase HOC Setup
function hocSetup(props, { attrs, slots, emit, expose }) {
    // UseCase Config
    const hocConfig = {
      fsmUrl: props.fsmUrl,
      batchRequired: false,
      activityCode: 'CRCARDI',
      subActivityCode: '',
      tolerateInit: false
    };
    // FSM AJAX helper
    const fsm = new FsmAjax(hocConfig);
    /// MegaSet1 - Models ///
    const ms1 = {
      ...
    };
    /// MegaSet1 - Config ///
    const megaSet1Config = ref({
      ...
    });
    /// MegaSet1 - Handlers ///
    const megaSet1Handlers = {
      ...
    };
    /// MegaSet2 - Models ///
    const ms2 = {
      ...
    };
    /// MegaSet2 - Config ///
    const megaSet2Config = ref({
      ...
    });
    /// MegaSet2 - Handlers ///
    const megaSet2Handlers = {
      ...
    };
    // UseCase Views
    const views = [
      {
        name: 'MegaSet1',
        title: megaSet1Config.value.screenTitle,
        component: MegaSet1,
        props: { configObj: megaSet1Config },
        handlers: megaSet1Handlers
      },
      {
        name: 'MegaSet2',
        title: megaSet2Config.value.screenTitle,
        component: MegaSet2,
        props: { configObj: megaSet2Config },
        handlers: megaSet2Handlers
      }
    ];
    // On UseCase Initialized
    function onInitialized(data) {
      ...
      activateView('MegaSet1');
    }
    // On UseCase (Initialize / Dispose) Error
    function onError(error, source) {
      helper.alert(error, `${source} - Error`);
    }
    // UseCase View Manager
    const {
      activateView,
      activeView,
      $refs,
      reinitialize,
      close,
      render
    } = useUseCaseViewManager(hocConfig, views, onInitialized, onError);
    // Return render function
    return render;
}
```

## `defineUseCaseComponent` Function

Defines Use Case Higher Order **Component** (UCHOC).

```javascript
function defineUseCaseComponent(name: String, setup: Function): VNode
```

### Example

```javascript
// UseCase HOC Name
const hocName = 'OBS_UC4_CC_CCI';
...
// UseCase HOC Setup
function hocSetup(props, { attrs, slots, emit, expose }) {
  ...
}
// Define UseCase HOC
const OBS_UC4_CC_CCI = defineUseCaseComponent(hocName, hocSetup);
export default OBS_UC4_CC_CCI;
```

## `defineUseCaseLoader` Function

Defines **Loader** for Use Case Higher Order Component (UCHOC).

```javascript
function defineUseCaseLoader(name: String, setup: Function): Function<function (ctx: VNode, fsmUrl: String): void>
```

### Example

```javascript
// UseCase HOC Name
const hocName = 'OBS_UC4_CC_CCI';
...
// UseCase HOC Setup
function hocSetup(props, { attrs, slots, emit, expose }) {
  ...
}
// Define UseCase HOC - Loader
const Loader = defineUseCaseLoader(hocName, hocSetup);
export default Loader;
```
